<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous"></script>
    <style>
        body { padding-top:50px; }
   </style>
          <script>
          var city,obj;
//A function to get user's location using HTML5 geolocation API
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else {
       alert("Geolocation is not supported by this browser.");
    }
}
function showPosition(position) {
    var x=position.coords.latitude + ","+position.coords.longitude;
    var city;
    var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
     city=JSON.parse(this.responseText).results[0].address_components[1].short_name;
     if(city==='Tiruchirappalli')
        city='trichy';
      else city="chennai"
      getContents(city);
    }
  };
  xhttp.open("GET", "https://maps.googleapis.com/maps/api/geocode/json?latlng="+x+"&key=AIzaSyA51eCYFSD_7bXVPpgh0fxPTuZNnl0IMDk", true);
  xhttp.send();
}
function groupBy(items,propertyName)
{
    var result = [];
    $.each(items, function(index, item) {
       if ($.inArray(item[propertyName], result)==-1) {
          result.push(item[propertyName]);
       }
    });
    return result;
}
function setButton()
{
  $('button').click(function(event){
    fetchMovies(event.target.id);
  });
}
function ImgError(ele)
{
  ele.src='download.png';
  ele.onerror="";
  return true;
}
function fetchMovies(language)
{
  var url='download.png'
  document.getElementById('selectLanguage').style.display='none';
  for(var i=0;i<obj.length;i++)
  {
    if(obj[i].language===language && obj[i].status=='Coming soon')
      $('#nowShowingCarousel .carousel-inner').append('<div class="item"><img src="'+obj[i].img+'" onerror="ImgError(this);"></div><div class="carousel-caption"><a href="'+obj[i].url+'">'+obj[i].title+"</a></div>");
    else if(obj[i].language===language && obj[i].status==="Now showing")
      $('#comingSoonCarousel .carousel-inner').append('<div class="item"><img src="'+obj[i].img+'" onerror="ImgError(this);"></div><div class="carousel-caption"><a href="'+obj[i].url+'">'+obj[i].title+"</a></div>");
  }
  $('#nowShowingCarousel>.carousel-inner:first-child').addClass('active');
  $('#comingSoonCarousel>.carousel-inner:first-child').addClass('active');


}
//fetching movie details for city
function getContents(city)
{
  var url = config.siteAddress
  console.log(url);
  var xhttp=new XMLHttpRequest();
  xhttp.onreadystatechange=function(){
  if(this.readyState==4 && this.status ==200){
    data=JSON.parse(this.responseText);
    var xhttp2=new XMLHttpRequest();
    xhttp2.onreadystatechange=function() {
      if(this.readyState==4 && this.status==200){
        obj=JSON.parse(this.responseText);
        console.log(obj);

var languages = groupBy(obj, 'language');
$.each( languages, function( index, value ){
    document.getElementById('selectLanguage').innerHTML+="<button id='"+value+"'>"+value+"</button>";
});
 setButton();
      }
    }
    xhttp2.open("post",url + '/scapeImage',true);
    xhttp2.setRequestHeader("Content-type", "application/json");
    xhttp2.send(JSON.stringify(data));

  }
  };
  xhttp.open("GET", url + '/scrape?city='+city, true);
  xhttp.send();
}

getLocation();
</script>
</head>
<body>

  <h2>List of movies</h2>
  <div id='selectLanguage'>
  <h3>Select a language</h3>
  </div>
  <div id='nowShowing'>
     <div id="nowShowingCarousel" class="carousel slide" data-ride="carousel">
    <!-- Wrapper for slides -->
    <div class="carousel-inner" role="listbox">

    </div>
[
    <!-- Left and right controls -->
    <a class="left carousel-control" href="#nowShowingCarousel" role="button" data-slide="prev">
      <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#nowShowingCarousel" role="button" data-slide="next">
      <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
  <hr>
  </div>
  <div id='comingSoon'>
  <div id="comingSoonCarousel" class="carousel slide" data-ride="carousel">
    <!-- Wrapper for slides -->
    <div class="carousel-inner" role="listbox">

    </div>

    <!-- Left and right controls -->
    <a class="left carousel-control" href="#comingSoonCarousel" role="button" data-slide="prev">
      <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#comingSoonCarousel" role="button" data-slide="next">
      <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
  <br>

</div>
</body>